generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// MULTI-TENANT RBAC HIERARCHY (Simplified)
// ============================================================
// Super Admin → owns Organization, full access
// Admin       → manager with full access
// User        → staff with permission toggles
// ============================================================

enum UserRole {
  super_admin // Organization owner - full access
  admin       // Manager - full access to organization
  user        // Staff - permissions controlled by admin
}

// ============================================================
// ORGANIZATION MODEL (Tenant Root)
// ============================================================
// Every piece of data belongs to an Organization.
// This ensures complete isolation between different organizations.
// ============================================================
model Organization {
  id        String   @id @default(cuid())
  name      String   // e.g., "Utkal Automobiles Pvt Ltd"
  slug      String   @unique // URL-friendly identifier: "utkal-automobiles"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - everything belongs to organization
  users          User[]
  featureToggles OrgFeatureToggle[]

  @@index([slug])
  @@index([isActive])
}

// ============================================================
// ORGANIZATION FEATURE TOGGLES
// ============================================================
// Super Admin can enable/disable features for entire organization.
// ============================================================
model OrgFeatureToggle {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Feature flags (master switches for the organization)
  dashboard             Boolean @default(true)
  dailyWalkinsVisitors  Boolean @default(true)
  dailyWalkinsSessions  Boolean @default(true)
  digitalEnquiry        Boolean @default(true)
  fieldInquiry          Boolean @default(true)
  deliveryUpdate        Boolean @default(true)
  exportExcel           Boolean @default(true)
  settingsProfile       Boolean @default(true)
  settingsVehicleModels Boolean @default(true)
  settingsLeadSources   Boolean @default(true)
  settingsWhatsApp      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId])
  @@index([organizationId])
}

// ============================================================
// DEALERSHIP MODEL (Legacy - keeps existing data working)
// ============================================================
model Dealership {
  id             String   @id @default(cuid())
  name           String
  location       String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  showroomNumber String?
  organizationId String?

  deliveryTickets   DeliveryTicket[]
  digitalEnquiries  DigitalEnquiry[]
  fieldInquiries    FieldInquiry[]
  leadSources       LeadSource[]
  users             User[]
  vehicleCategories VehicleCategory[]
  visitors          Visitor[]
  whatsappTemplates WhatsAppTemplate[]

  @@index([organizationId])
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole @default(user)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant isolation
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // Legacy field for backward compatibility
  dealershipId String?
  dealership   Dealership? @relation(fields: [dealershipId], references: [id])

  // User preferences
  theme          String  @default("light")
  profilePicture String?

  // Granular permissions (for users, admins have all by default)
  permissions UserPermission?

  @@index([organizationId])
  @@index([dealershipId])
}

model VehicleCategory {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dealershipId String?
  dealership   Dealership? @relation(fields: [dealershipId], references: [id], onDelete: Cascade)

  models VehicleModel[]

  @@unique([dealershipId, name])
  @@index([dealershipId])
}

model VehicleModel {
  id               String            @id @default(cuid())
  name             String
  year             Int?
  categoryId       String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deliveryTickets  DeliveryTicket[]
  digitalEnquiries DigitalEnquiry[]
  fieldInquiries   FieldInquiry[]
  testDrives       TestDrive[]
  category         VehicleCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  variants         VehicleVariant[]
  visitorInterests VisitorInterest[]

  @@index([categoryId])
}

model VehicleVariant {
  id               String            @id @default(cuid())
  name             String
  modelId          String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deliveryTickets  DeliveryTicket[]
  digitalEnquiries DigitalEnquiry[]
  fieldInquiries   FieldInquiry[]
  testDrives       TestDrive[]
  model            VehicleModel      @relation(fields: [modelId], references: [id], onDelete: Cascade)
  visitorInterests VisitorInterest[]

  @@unique([modelId, name])
  @@index([modelId])
}

model Visitor {
  id                String   @id @default(cuid())
  firstName         String
  lastName          String
  whatsappNumber    String
  email             String?
  address           String?
  whatsappContactId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  dealershipId String?
  dealership   Dealership? @relation(fields: [dealershipId], references: [id], onDelete: Cascade)

  interests VisitorInterest[]
  sessions  VisitorSession[]

  @@index([dealershipId])
  @@index([whatsappNumber])
}

model VisitorSession {
  id               String            @id @default(cuid())
  reason           String
  status           String            @default("intake")
  visitorId        String
  feedback         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  testDrives       TestDrive[]
  visitorInterests VisitorInterest[]
  visitor          Visitor           @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@index([visitorId])
  @@index([status])
}

model VisitorInterest {
  id        String          @id @default(cuid())
  visitorId String
  modelId   String
  createdAt DateTime        @default(now())
  sessionId String?
  variantId String?
  model     VehicleModel    @relation(fields: [modelId], references: [id], onDelete: Cascade)
  session   VisitorSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  variant   VehicleVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  visitor   Visitor         @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@unique([visitorId, modelId, variantId, sessionId])
  @@index([visitorId])
  @@index([modelId])
  @@index([variantId])
  @@index([sessionId])
}

model TestDrive {
  id        String          @id @default(cuid())
  sessionId String
  modelId   String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  variantId String?
  model     VehicleModel    @relation(fields: [modelId], references: [id], onDelete: Cascade)
  session   VisitorSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  variant   VehicleVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([modelId])
  @@index([variantId])
}

model WhatsAppTemplate {
  id           String   @id @default(cuid())
  name         String
  templateId   String
  templateName String
  language     String   @default("en_US")
  type         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  section      String?  @default("global")

  dealershipId String?
  dealership   Dealership? @relation(fields: [dealershipId], references: [id], onDelete: Cascade)

  @@unique([dealershipId, type, section])
  @@index([dealershipId])
}

model LeadSource {
  id        String   @id @default(cuid())
  name      String
  order     Int      @default(0)
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dealershipId String?
  dealership   Dealership? @relation(fields: [dealershipId], references: [id], onDelete: Cascade)

  digitalEnquiries DigitalEnquiry[]
  fieldInquiries   FieldInquiry[]

  @@unique([dealershipId, name])
  @@index([dealershipId])
}

model DigitalEnquiry {
  id                  String   @id @default(cuid())
  firstName           String
  lastName            String
  whatsappNumber      String
  email               String?
  address             String?
  reason              String
  leadScope           String   @default("warm")
  whatsappContactId   String?
  leadSourceId        String?
  interestedModelId   String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  interestedVariantId String?
  modelText           String?
  sourceText          String?

  dealershipId String?
  dealership   Dealership? @relation(fields: [dealershipId], references: [id], onDelete: Cascade)

  model      VehicleModel?           @relation(fields: [interestedModelId], references: [id])
  variant    VehicleVariant?         @relation(fields: [interestedVariantId], references: [id])
  leadSource LeadSource?             @relation(fields: [leadSourceId], references: [id])
  sessions   DigitalEnquirySession[]

  @@index([dealershipId])
  @@index([whatsappNumber])
  @@index([leadSourceId])
}

model DigitalEnquirySession {
  id               String         @id @default(cuid())
  notes            String?
  status           String         @default("active")
  digitalEnquiryId String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  digitalEnquiry   DigitalEnquiry @relation(fields: [digitalEnquiryId], references: [id], onDelete: Cascade)

  @@index([digitalEnquiryId])
  @@index([status])
}

model DeliveryTicket {
  id                String   @id @default(cuid())
  firstName         String
  lastName          String
  whatsappNumber    String
  email             String?
  address           String?
  description       String?
  deliveryDate      DateTime
  messageSent       Boolean  @default(false)
  whatsappContactId String?
  modelId           String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  variantId         String?
  completionSent    Boolean  @default(false)
  status            String   @default("active")

  dealershipId String?
  dealership   Dealership? @relation(fields: [dealershipId], references: [id], onDelete: Cascade)

  model             VehicleModel       @relation(fields: [modelId], references: [id], onDelete: Cascade)
  variant           VehicleVariant?    @relation(fields: [variantId], references: [id])
  scheduledMessages ScheduledMessage[]

  @@index([dealershipId])
  @@index([whatsappNumber])
  @@index([deliveryDate])
  @@index([modelId])
}

model ScheduledMessage {
  id               String         @id @default(cuid())
  scheduledFor     DateTime
  sentAt           DateTime?
  status           String         @default("pending")
  retryCount       Int            @default(0)
  deliveryTicketId String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  deliveryTicket   DeliveryTicket @relation(fields: [deliveryTicketId], references: [id], onDelete: Cascade)

  @@index([deliveryTicketId])
  @@index([scheduledFor])
  @@index([status])
}

model FieldInquiry {
  id                  String   @id @default(cuid())
  firstName           String
  lastName            String
  whatsappNumber      String
  email               String?
  address             String?
  reason              String
  leadScope           String   @default("warm")
  whatsappContactId   String?
  leadSourceId        String?
  interestedModelId   String?
  interestedVariantId String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  dealershipId String?
  dealership   Dealership? @relation(fields: [dealershipId], references: [id], onDelete: Cascade)

  model      VehicleModel?         @relation(fields: [interestedModelId], references: [id])
  variant    VehicleVariant?       @relation(fields: [interestedVariantId], references: [id])
  leadSource LeadSource?           @relation(fields: [leadSourceId], references: [id])
  sessions   FieldInquirySession[]

  @@index([dealershipId])
  @@index([whatsappNumber])
  @@index([leadSourceId])
}

model FieldInquirySession {
  id             String       @id @default(cuid())
  notes          String?
  status         String       @default("active")
  fieldInquiryId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  fieldInquiry   FieldInquiry @relation(fields: [fieldInquiryId], references: [id], onDelete: Cascade)

  @@index([fieldInquiryId])
  @@index([status])
}

model UserPermission {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Feature permissions
  dashboard Boolean @default(false)

  // Daily Walkins - granular control
  dailyWalkinsVisitors Boolean @default(false)
  dailyWalkinsSessions Boolean @default(false)

  digitalEnquiry Boolean @default(false)
  fieldInquiry   Boolean @default(false)
  deliveryUpdate Boolean @default(false)
  exportExcel    Boolean @default(false)

  // Settings - granular control for each tab
  settingsProfile       Boolean @default(false)
  settingsVehicleModels Boolean @default(false)
  settingsLeadSources   Boolean @default(false)
  settingsWhatsApp      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

enum BulkUploadJobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

model BulkUploadJob {
  id            String              @id @default(cuid())
  jobId         String              @unique
  type          String
  status        BulkUploadJobStatus @default(QUEUED)
  totalRows     Int
  processedRows Int                 @default(0)
  successCount  Int                 @default(0)
  errorCount    Int                 @default(0)
  failedRows    Json?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  completedAt   DateTime?

  dealershipId String?

  @@index([dealershipId])
  @@index([status])
  @@index([createdAt])
}

model BulkUploadJobResult {
  id        String   @id @default(cuid())
  jobId     String
  rowNumber Int
  success   Boolean
  data      Json?
  error     String?
  createdAt DateTime @default(now())

  @@index([jobId])
  @@index([createdAt])
}
