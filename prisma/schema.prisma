// Prisma schema for showroom visitor management system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// User authentication and management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Dealership association
  dealership   Dealership? @relation(fields: [dealershipId], references: [id])
  dealershipId String?

  // Theme preferences
  theme       String @default("light") // light, dark

  // Profile picture
  profilePicture String? // Path to profile picture in public folder

  @@index([dealershipId])
}

// Dealership/Company information
model Dealership {
  id             String  @id @default(cuid())
  name           String
  location       String
  showroomNumber String? // Phone number for showroom (used in templates)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users             User[]
  vehicleCategories VehicleCategory[]
  visitors          Visitor[]
  whatsappTemplates WhatsAppTemplate[]
  leadSources       LeadSource[]
  digitalEnquiries  DigitalEnquiry[]
  fieldInquiries    FieldInquiry[]
  deliveryTickets   DeliveryTicket[]
}

// Vehicle categories (e.g., Car, Bike, Coupe, SUV, etc.)
model VehicleCategory {
  id   String @id @default(cuid())
  name String

  dealership   Dealership @relation(fields: [dealershipId], references: [id], onDelete: Cascade)
  dealershipId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  models VehicleModel[]

  @@unique([dealershipId, name])
  @@index([dealershipId])
}

// Vehicle models under categories
model VehicleModel {
  id   String @id @default(cuid())
  name String
  year Int?

  category   VehicleCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  variants         VehicleVariant[]
  visitorInterests VisitorInterest[]
  testDrives       TestDrive[]
  digitalEnquiries DigitalEnquiry[]
  fieldInquiries   FieldInquiry[]
  deliveryTickets  DeliveryTicket[]

  @@index([categoryId])
}

// Vehicle variants under models (e.g., test3.xl, test3.s)
model VehicleVariant {
  id   String @id @default(cuid())
  name String // Variant name like "xl", "s", "base"

  model   VehicleModel @relation(fields: [modelId], references: [id], onDelete: Cascade)
  modelId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  visitorInterests VisitorInterest[]
  testDrives       TestDrive[]
  digitalEnquiries DigitalEnquiry[]
  fieldInquiries   FieldInquiry[]
  deliveryTickets  DeliveryTicket[]

  @@unique([modelId, name])
  @@index([modelId])
}

// Visitor contact information
model Visitor {
  id             String  @id @default(cuid())
  firstName      String
  lastName       String
  whatsappNumber String
  email          String?
  address        String?

  // WhatsApp contact ID from the API
  whatsappContactId String?

  dealership   Dealership @relation(fields: [dealershipId], references: [id], onDelete: Cascade)
  dealershipId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions  VisitorSession[]
  interests VisitorInterest[]

  @@index([dealershipId])
  @@index([whatsappNumber])
}

// Visitor session tracking
model VisitorSession {
  id     String @id @default(cuid())
  reason String // Why they're visiting

  // Session status: intake, test_drive, completed, exited
  status String @default("intake")

  visitor   Visitor @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  visitorId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  testDrives       TestDrive[]
  visitorInterests VisitorInterest[]

  @@index([visitorId])
  @@index([status])
}

// Vehicle models the visitor is interested in
model VisitorInterest {
  id String @id @default(cuid())

  visitor   Visitor @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  visitorId String

  model   VehicleModel @relation(fields: [modelId], references: [id], onDelete: Cascade)
  modelId String

  // Optional variant selection
  variant   VehicleVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  variantId String?

  // Link to session to track which visit this interest is from
  session   VisitorSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String?

  createdAt DateTime @default(now())

  @@unique([visitorId, modelId, variantId, sessionId])
  @@index([visitorId])
  @@index([modelId])
  @@index([variantId])
  @@index([sessionId])
}

// Test drive records
model TestDrive {
  id String @id @default(cuid())

  session   VisitorSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId String

  model   VehicleModel @relation(fields: [modelId], references: [id], onDelete: Cascade)
  modelId String

  // Optional variant selection
  variant   VehicleVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  variantId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([modelId])
  @@index([variantId])
}

// WhatsApp template configurations
model WhatsAppTemplate {
  id           String @id @default(cuid())
  name         String // Internal name
  templateId   String // API template ID
  templateName String // API template name
  language     String @default("en_US")

  // Template type: welcome, test_drive, exit, digital_enquiry, field_inquiry, delivery_reminder
  type String

  // Section: daily_walkins, digital_enquiry, field_inquiry, delivery_update, or global
  section String? @default("global")

  dealership   Dealership @relation(fields: [dealershipId], references: [id], onDelete: Cascade)
  dealershipId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([dealershipId, type, section])
  @@index([dealershipId])
}

// Lead source options (configurable in Global Settings)
model LeadSource {
  id        String  @id @default(cuid())
  name      String
  order     Int     @default(0)
  isDefault Boolean @default(false) // For default sources that can't be deleted

  dealership   Dealership @relation(fields: [dealershipId], references: [id], onDelete: Cascade)
  dealershipId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  digitalEnquiries DigitalEnquiry[]
  fieldInquiries   FieldInquiry[]

  @@unique([dealershipId, name])
  @@index([dealershipId])
}

// Digital enquiry/lead tracking
model DigitalEnquiry {
  id             String  @id @default(cuid())
  firstName      String
  lastName       String
  whatsappNumber String
  email          String?
  address        String?
  reason         String // Reason for enquiry
  leadScope      String  @default("warm") // Lead status: hot, warm, cold

  // WhatsApp contact ID from the API
  whatsappContactId String?

  dealership   Dealership @relation(fields: [dealershipId], references: [id], onDelete: Cascade)
  dealershipId String

  leadSource   LeadSource? @relation(fields: [leadSourceId], references: [id], onDelete: SetNull)
  leadSourceId String?

  model             VehicleModel? @relation(fields: [interestedModelId], references: [id], onDelete: SetNull)
  interestedModelId String?

  // Optional variant selection
  variant             VehicleVariant? @relation(fields: [interestedVariantId], references: [id], onDelete: SetNull)
  interestedVariantId String?

  // Relations
  sessions DigitalEnquirySession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealershipId])
  @@index([whatsappNumber])
  @@index([leadSourceId])
}

// Digital Enquiry Session tracking
model DigitalEnquirySession {
  id     String  @id @default(cuid())
  notes  String? // Session notes or follow-up information
  status String  @default("active") // active, completed, closed

  digitalEnquiry   DigitalEnquiry @relation(fields: [digitalEnquiryId], references: [id], onDelete: Cascade)
  digitalEnquiryId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([digitalEnquiryId])
  @@index([status])
}

// Delivery ticket/client information
model DeliveryTicket {
  id             String   @id @default(cuid())
  firstName      String
  lastName       String
  whatsappNumber String
  email          String?
  address        String?
  description    String? // Description/notes
  deliveryDate   DateTime
  messageSent    Boolean  @default(false) // Whether message has been sent
  completionSent Boolean  @default(false) // Whether completion message has been sent
  status         String   @default("active") // active, closed

  // WhatsApp contact ID from the API
  whatsappContactId String?

  dealership   Dealership @relation(fields: [dealershipId], references: [id], onDelete: Cascade)
  dealershipId String

  model   VehicleModel @relation(fields: [modelId], references: [id], onDelete: Cascade)
  modelId String

  // Optional variant selection
  variant   VehicleVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  scheduledMessages ScheduledMessage[]

  @@index([dealershipId])
  @@index([whatsappNumber])
  @@index([deliveryDate])
  @@index([modelId])
}

// Scheduled WhatsApp messages for delivery reminders
model ScheduledMessage {
  id           String    @id @default(cuid())
  scheduledFor DateTime // When to send the message
  sentAt       DateTime? // When it was actually sent
  status       String    @default("pending") // pending, sent, failed
  retryCount   Int       @default(0)

  deliveryTicket   DeliveryTicket @relation(fields: [deliveryTicketId], references: [id], onDelete: Cascade)
  deliveryTicketId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deliveryTicketId])
  @@index([scheduledFor])
  @@index([status])
}

// Field enquiry/lead tracking
model FieldInquiry {
  id             String  @id @default(cuid())
  firstName      String
  lastName       String
  whatsappNumber String
  email          String?
  address        String?
  reason         String // Reason for enquiry
  leadScope      String  @default("warm") // Lead status: hot, warm, cold

  // WhatsApp contact ID from the API
  whatsappContactId String?

  dealership   Dealership @relation(fields: [dealershipId], references: [id], onDelete: Cascade)
  dealershipId String

  leadSource   LeadSource? @relation(fields: [leadSourceId], references: [id], onDelete: SetNull)
  leadSourceId String?

  model             VehicleModel? @relation(fields: [interestedModelId], references: [id], onDelete: SetNull)
  interestedModelId String?

  // Optional variant selection
  variant             VehicleVariant? @relation(fields: [interestedVariantId], references: [id], onDelete: SetNull)
  interestedVariantId String?

  // Relations
  sessions FieldInquirySession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dealershipId])
  @@index([whatsappNumber])
  @@index([leadSourceId])
}

// Field Enquiry Session tracking
model FieldInquirySession {
  id     String  @id @default(cuid())
  notes  String? // Session notes or follow-up information
  status String  @default("active") // active, completed, closed

  fieldInquiry   FieldInquiry @relation(fields: [fieldInquiryId], references: [id], onDelete: Cascade)
  fieldInquiryId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fieldInquiryId])
  @@index([status])
}
